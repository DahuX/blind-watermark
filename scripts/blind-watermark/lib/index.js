"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _privateWt=_interopRequireDefault(require("./utils/privateWt")),_imgData=_interopRequireDefault(require("./utils/imgData")),_strided=_interopRequireDefault(require("./utils/strided")),_matrixPassword=_interopRequireDefault(require("./utils/matrixPassword")),_stringCode=_interopRequireDefault(require("./utils/stringCode"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],n=!0,i=!1,a=void 0;try{for(var o,l=e[Symbol.iterator]();!(n=(o=l.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{n||null==l.return||l.return()}finally{if(i)throw a}}return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var getWmResult=function(e,t,r,n){if("bool"===t)return e;if("string"===t){var i=e.map((function(e){return Number(e)})).join("");return _stringCode.default.charCode2str(i)}if("img"===t){var a=_slicedToArray(r,2),o=a[0],l=a[1];_imgData.default.setTwoEnds({data:e,width:o,height:l},n)}},WaterMark=function(){function WaterMark(){_classCallCheck(this,WaterMark),this.blockShape=8,this.lowChannel=[],this.heightChannel=[],this.wmBoolList=[],this.addWidth=!1,this.addHeight=!1,this.fullRowNun=0,this.fullColumnNun=0}return _createClass(WaterMark,[{key:"readImg",value:function(e){var t=this,r=_imgData.default.getData(e),n=(r.imgData,r.width),i=r.height,a=r.R,o=r.G,l=r.B,s=r.A;this.A=s,this.width=n,this.height=i,n%2!=0&&(this.addWidth=!0,a=a.map((function(e){return e[n]=0,e})),o=o.map((function(e){return e[n]=0,e})),l=l.map((function(e){return e[n]=0,e}))),i%2!=0&&(this.addHeight=!0,a[i]=new Array(n).fill(0),o[i]=new Array(n).fill(0),l[i]=new Array(n).fill(0)),[a,o,l].forEach((function(e,r){var n=_slicedToArray(_privateWt.default.dwt(e),2),i=n[0],a=n[1];t.lowChannel[r]=i,t.heightChannel[r]=a})),this.lowChannel=this.lowChannel.map((function(e){var r=_strided.default.strided4(e,t.blockShape),n=r.fullRowNun,i=r.fullColumnNun,a=r.result;return t.fullRowNun=n,t.fullColumnNun=i,a}))}},{key:"readWm",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bool";if(e){if("bool"===t){if(e.find((function(e){return"boolean"!=typeof e})))return void console.error("水印中存在非布尔值，请检查",e);var r=this.lowChannel.length*this.lowChannel[0].length;return e.length>r?void console.error("最多可嵌入".concat(r/1e3,"kb信息，当前信息过大约为").concat(e.length/1e3)):(this.wmBoolList=e,void(this.wmLength=e.length))}if("string"!==t){if("img"===t){var n=_imgData.default.getTwoEnds(e),i=n.width,a=n.height,o=n.data;return this.imgWmSize=[i,a],void this.readWm(o,"bool")}console.error("水印类型错误，请输入 bool | string | img, 当前为",t)}else{var l=_stringCode.default.str2charCode(e),s=l.split("").map((function(e){return 1==e}));this.readWm(s,"bool")}}else console.error("请输入水印",e)}},{key:"mixWm",value:function(e){var t=this;if(0!==this.wmBoolList.length){this.lowChannel.forEach((function(e){for(var r=0,n=0;n<t.fullRowNun;n++)for(var i=0;i<t.fullColumnNun;i++){var a=e[n][i],o=t.wmBoolList[r%t.wmLength];r++,e[n][i]=_matrixPassword.default.encode(a,o)}}));var r=_slicedToArray(this.lowChannel.map((function(e,r){var n=_strided.default.spreadStrided4(e),i=_privateWt.default.idwt(n,t.heightChannel[r]);return t.addHeight&&i.pop(),t.addWidth&&i.forEach((function(e){return e.pop()})),i})),3),n=r[0],i=r[1],a=r[2],o=this.A,l=this.width,s=this.height;this.lowChannel=[],this.heightChannel=[],this.wmBoolList=[],this.addWidth=!1,this.addHeight=!1,_imgData.default.setData({R:n,G:i,B:a,A:o,width:l,height:s},!0,e)}}},{key:"addWm",value:function(e){var t=this,r=e.originImg,n=e.wm,i=e.wmType,a=e.name;return this.readImg(r),this.readWm(n,i),this.mixWm(a),new Promise((function(e){var r=t.wmLength;"img"===i&&(r=t.imgWmSize),e({wmLength:r})}))}},{key:"extract",value:function extract(_ref2){var _this4=this,wmImg=_ref2.wmImg,wmLength=_ref2.wmLength,wmType=_ref2.wmType,name=_ref2.name;if(wmLength)if("string"!==wmType&&"bool"!==wmType||!isNaN(Number(wmLength))){if("img"!==wmType||Array.isArray(wmLength)&&2===wmLength.length){var currentTypeWmLength=wmLength;"string"===wmType&&(currentTypeWmLength=16*wmLength),"img"===wmType&&(currentTypeWmLength=wmLength[0]*wmLength[1]),this.readImg(wmImg);var passWordList=[],channelWm=this.lowChannel.map((function(e){for(var t=[],r=0,n=0;n<_this4.fullRowNun;n++)for(var i=0;i<_this4.fullColumnNun;i++){var a=e[n][i],o=_matrixPassword.default.decode(a),l=[r%currentTypeWmLength];passWordList[l]||(passWordList[l]=[]),passWordList[l].push(o),r++,t.push(o)}return t})),wmList=passWordList.map((function(arr){return eval(arr.join("+"))/arr.length>.5})),result=getWmResult(wmList,wmType,wmLength,name);return new Promise((function(e,t){e({wm:result})}))}console.error("wmLength 需为数组，[width, height]",wmLength)}else console.error("wmLength 需为数字，代表水印长度",wmLength);else console.error("请输入水印长度, 水印类型为 string bool 时，wmLength 输入数字，水印类型为 img 时，wmLength 为二维数组代表图片宽高 [width, height]",wmLength)}}]),WaterMark}(),_default=new WaterMark;exports.default=_default;